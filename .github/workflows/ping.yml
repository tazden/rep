name: Update news (hourly)

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Call Supabase Edge Function
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}            # https://xxxx.supabase.co
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}  # anon key (eyJ...)
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          set -euo pipefail

          if [ -z "${SUPABASE_ANON_KEY:-}" ]; then
            echo "ERROR: SUPABASE_ANON_KEY is empty. Add it to GitHub Secrets."
            exit 1
          fi

          URL="${SUPABASE_URL%/}/functions/v1/update-news"
          echo "Calling: $URL"
          echo "ANON_KEY length: ${#SUPABASE_ANON_KEY}"

          http_code=$(curl -sS -L -o resp.json -w "%{http_code}" -X POST "$URL" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "x-cron-secret: ${CRON_SECRET}" \
            -H "Content-Type: application/json" \
            --data '{"targets":["football","hockey","boxing"]}')

          echo "HTTP_STATUS:$http_code"
          echo "---- RESPONSE ----"
          cat resp.json
          echo ""
          echo "------------------"

          if [ "$http_code" -ne 200 ]; then
            echo "Request failed with HTTP $http_code"
            exit 1
          fi

          ok=$(python3 -c "import json; d=json.load(open('resp.json','r',encoding='utf-8')); print(str(d.get('ok', False)).lower())")
          if [ "$ok" != "true" ]; then
            echo "Function returned ok=false"
            exit 1
          fi
